DROP TABLE IF EXISTS municipio_rate_ano;
CREATE TABLE municipio_rate_ano (
  municipio TEXT NOT NULL,    homicidio TEXT NOT NULL,    furtos_veiculo TEXT NOT NULL,    furtos TEXT NOT NULL,    roubos TEXT NOT NULL,    latrocionio TEXT NOT NULL,    roubo_veiculo TEXT NOT NULL,    extorsao TEXT NOT NULL,    extorsao_sequesto TEXT NOT NULL,    estelionato TEXT NOT NULL,    delitos_corrupcao TEXT NOT NULL,    posse_entorpecente TEXT NOT NULL,    delitos_municoes TEXT NOT NULL,    trafico_entorpecente TEXT NOT NULL,  populacao INT,    rate_homicidio FLOAT NOT NULL,    rate_furtos_veiculo FLOAT NOT NULL,    rate_furtos FLOAT NOT NULL,    rate_roubos FLOAT NOT NULL,    rate_latrocionio FLOAT NOT NULL,    rate_roubo_veiculo FLOAT NOT NULL,    rate_extorsao FLOAT NOT NULL,    rate_extorsao_sequesto FLOAT NOT NULL,    rate_estelionato FLOAT NOT NULL,    rate_delitos_corrupcao FLOAT NOT NULL,    rate_posse_entorpecente FLOAT NOT NULL,    rate_delitos_municoes FLOAT NOT NULL,    rate_trafico_entorpecente FLOAT NOT NULL,  ano INT
);
CREATE UNIQUE INDEX ON municipio_rate_ano (municipio, ano);
CREATE INDEX ON municipio_rate_ano (ano);
INSERT INTO municipio_rate_ano (
municipio,     homicidio,     furtos_veiculo,     furtos,     roubos,     latrocionio,     roubo_veiculo,     extorsao,     extorsao_sequesto,     estelionato,     delitos_corrupcao,     posse_entorpecente,     delitos_municoes,     trafico_entorpecente,populacao,     rate_homicidio,     rate_furtos_veiculo,     rate_furtos,     rate_roubos,     rate_latrocionio,     rate_roubo_veiculo,     rate_extorsao,     rate_extorsao_sequesto,     rate_estelionato,     rate_delitos_corrupcao,     rate_posse_entorpecente,     rate_delitos_municoes,     rate_trafico_entorpecente,ano )
SELECT mits.nome_ibge,         rism.homicidio,         rism.furtos_veiculo,         rism.furtos,         rism.roubos,         rism.latrocionio,         rism.roubo_veiculo,         rism.extorsao,         rism.extorsao_sequesto,         rism.estelionato,         rism.delitos_corrupcao,         rism.posse_entorpecente,         rism.delitos_municoes,         rism.trafico_entorpecente,       ric.valor as populacao,         (rism.homicidio/ric.valor) * 100000           AS rate_homicidio,         (rism.furtos_veiculo/ric.valor) * 100000           AS rate_furtos_veiculo,         (rism.furtos/ric.valor) * 100000           AS rate_furtos,         (rism.roubos/ric.valor) * 100000           AS rate_roubos,         (rism.latrocionio/ric.valor) * 100000           AS rate_latrocionio,         (rism.roubo_veiculo/ric.valor) * 100000           AS rate_roubo_veiculo,         (rism.extorsao/ric.valor) * 100000           AS rate_extorsao,         (rism.extorsao_sequesto/ric.valor) * 100000           AS rate_extorsao_sequesto,         (rism.estelionato/ric.valor) * 100000           AS rate_estelionato,         (rism.delitos_corrupcao/ric.valor) * 100000           AS rate_delitos_corrupcao,         (rism.posse_entorpecente/ric.valor) * 100000           AS rate_posse_entorpecente,         (rism.delitos_municoes/ric.valor) * 100000           AS rate_delitos_municoes,         (rism.trafico_entorpecente/ric.valor) * 100000           AS rate_trafico_entorpecente,
       rism.ano
 FROM municipio_ibge_to_ssprs mits
 JOIN raw_indicadores_ssprs_municipioss rism
   ON rism.municipio = mits.nome_ssprs
 JOIN raw_ibge_censo ric
   ON ric.cidade = mits.nome_ibge
WHERE ric.descricao ~ 'População residente\s+$'
GROUP BY mits.nome_ibge,        rism.homicidio,        rism.furtos_veiculo,        rism.furtos,        rism.roubos,        rism.latrocionio,        rism.roubo_veiculo,        rism.extorsao,        rism.extorsao_sequesto,        rism.estelionato,        rism.delitos_corrupcao,        rism.posse_entorpecente,        rism.delitos_municoes,        rism.trafico_entorpecente,      rism.ano,
      rism.homicidio,
      ric.valor
ORDER BY        rate_homicidio,        rate_furtos_veiculo,        rate_furtos,        rate_roubos,        rate_latrocionio,        rate_roubo_veiculo,        rate_extorsao,        rate_extorsao_sequesto,        rate_estelionato,        rate_delitos_corrupcao,        rate_posse_entorpecente,        rate_delitos_municoes,        rate_trafico_entorpecente,      mits.nome_ibge, rism.ano;
